// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_DATABASE_URL")
}

// 用户表
model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String
  password        String
  phone           String?
  avatar          String?   // 新增：用户头像
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  lastLoginAt     DateTime? // 新增：最后登录时间
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关系
  cases    Case[]
  messages Message[] @relation("UserMessages")

  @@map("users")
}

// 移民顾问表（RCIC）
model RCIC {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  phone     String?
  avatar    String?   // 新增：顾问头像
  
  // 邮箱验证
  emailVerified          Boolean   @default(false)
  emailVerifiedAt        DateTime?
  verificationToken      String?   // 邮箱验证token
  verificationTokenExpiry DateTime? // 验证token过期时间
  
  // 顾问类型和资质
  consultantType    String    @default("A") // A: 持牌顾问, B: 留学顾问, C: 文案辅助
  licenseNumber     String?   // RCIC 执照编号（A类必填）
  licenseNo         String?   // 新增：兼容旧代码的字段名
  level             String?   // 新增：顾问等级（兼容旧代码）
  licenseVerified   Boolean   @default(false)
  licenseExpiryDate DateTime? // 执照过期日期
  yearsOfExperience Int?      // 从业年限
  
  // 审核状态
  approvalStatus  String    @default("pending") // pending, under_review, approved, rejected, suspended
  approvalNotes   String?   // 审核备注
  approvedAt      DateTime? // 审核通过时间
  approvedBy      String?   // 审核人员ID
  
  // 资质文档
  idDocument        String? // 身份证件
  licenseDocument   String? // 执照文件
  experienceProof   String? // 从业证明
  videoVerification String? // 视频认证
  
  // 审核时间
  lastReviewDate DateTime? // 最后审核日期
  nextReviewDate DateTime? // 下次审核日期（持牌顾问6-12个月复核）
  
  // 账号和在线状态（新增）
  isActive      Boolean   @default(true)  // 账号是否激活（是否被禁用/封号）
  isOnline      Boolean   @default(false) // 是否在线
  lastLoginAt   DateTime? // 最后登录时间
  lastActiveAt  DateTime? // 最后活跃时间
  
  // 基本信息
  country      String?
  city         String?
  organization String? // 执业机构
  bio          String? // 个人简介
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关系
  cases    Case[]
  messages Message[] @relation("RCICMessages")
  sessions RCICSession[] // 新增：会话关系

  @@map("rcics")
}

// RCIC 会话表（新增）
model RCICSession {
  id        String   @id @default(cuid())
  rcicId    String
  token     String   @unique
  expiresAt DateTime
  userAgent String?
  ipAddress String?
  createdAt DateTime @default(now())

  // 关系
  rcic RCIC @relation(fields: [rcicId], references: [id], onDelete: Cascade)

  @@index([rcicId])
  @@index([token])
  @@map("rcic_sessions")
}

// 案件表
model Case {
  id          String   @id @default(cuid())
  userId      String
  rcicId      String?
  type        String // visitor_visa, study_permit, immigration
  status      String   @default("pending") // pending, in_progress, completed, cancelled
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关系
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rcic     RCIC?     @relation(fields: [rcicId], references: [id], onDelete: SetNull)
  messages Message[]

  @@index([userId])
  @@index([rcicId])
  @@map("cases")
}

// 消息表
model Message {
  id         String   @id @default(cuid())
  caseId     String
  senderId   String
  senderType String // user or rcic
  content    String
  attachments String? // JSON array of file URLs
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  // 关系 - 使用命名关系和自定义外键名称
  case Case  @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user User? @relation("UserMessages", fields: [senderId], references: [id], onDelete: Cascade, map: "messages_user_fkey")
  rcic RCIC? @relation("RCICMessages", fields: [senderId], references: [id], onDelete: Cascade, map: "messages_rcic_fkey")

  @@index([caseId])
  @@index([senderId])
  @@map("messages")
}

// RCIC团队成员表（阶段1：最简化版本）
model RCICTeamMember {
  id        String   @id @default(cuid())
  rcicId    String   // 所属RCIC的ID（不使用外键，避免复杂关系）
  email     String   @unique
  name      String
  password  String
  role      String   @default("operator") // operator: 文案/操作员
  
  // 邮箱验证
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  
  // 状态
  isActive    Boolean   @default(true)  // 是否启用
  lastLoginAt DateTime? // 最后登录时间
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rcicId])
  @@map("rcic_team_members")
}

// RCIC团队成员会话表
model RCICTeamMemberSession {
  id        String   @id @default(cuid())
  memberId  String   // 团队成员ID（不使用外键，避免复杂关系）
  token     String   @unique
  expiresAt DateTime
  userAgent String?
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([memberId])
  @@index([token])
  @@map("rcic_team_member_sessions")
}

// 邮箱验证令牌表
model VerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  type      String   // email_verification, password_reset
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
  @@map("verification_tokens")
}

// 内部对话表（RCIC和团队成员之间的一对一对话）
model InternalConversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 对话参与者（两个人）
  participant1Id   String
  participant1Type String // "rcic" 或 "team_member"
  participant2Id   String
  participant2Type String // "rcic" 或 "team_member"

  // 最后一条消息
  lastMessageAt      DateTime?
  lastMessageContent String?

  // 关系
  messages InternalMessage[]

  @@unique([participant1Id, participant2Id])
  @@map("internal_conversations")
}

// 内部消息表
model InternalMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // 消息内容
  content     String?
  messageType String  @default("text") // "text", "file", "image"

  // 文件信息（如果是文件或图片）
  fileUrl      String?
  fileName     String?
  fileSize     Int?
  fileMimeType String?

  // 发送者
  senderId   String
  senderType String // "rcic" 或 "team_member"

  // 接收者
  receiverId   String
  receiverType String // "rcic" 或 "team_member"

  // 已读状态
  isRead Boolean @default(false)
  readAt DateTime?

  // 关联对话
  conversationId String
  conversation   InternalConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("internal_messages")
}
