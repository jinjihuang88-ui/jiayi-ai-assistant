# AI 咨询（扣子）优化与替代方案

## 一、回复慢的原因分析

当前 AI 咨询对接的是 **扣子（Coze）中国版** 的智能体，可能偏慢的主要原因：

1. **非流式请求**  
   之前使用 `stream: false`，必须等智能体**整段生成完毕**后才一次性返回。扣子端可能包含：大模型推理、知识库检索、插件调用等，整体耗时会叠加，体感就是“等很久才出一整段”。

2. **无多轮会话**  
   每次请求使用新的 `user: "web_user_" + Date.now()`，未传 `conversation_id`，相当于**每句都是新会话**。多轮上下文和会话级优化都用不上，也可能略微增加首包时间。

3. **智能体自身耗时**  
   若智能体配置了 RAG、联网、多步推理等，单次响应时间本身就会在数秒到十几秒，与是否流式无关，但流式可以**让首字更快出现**，体感更好。

---

## 二、已做的优化

- **流式接口**：新增 `POST /api/chat/stream`，请求扣子时使用 `stream: true`，将内容以 NDJSON 流式返回。
- **前端逐字显示**：`/chat` 页的 ChatBox 改为调用流式接口，边收边渲染，首字更快出现，体感延迟明显降低。
- **多轮会话**：前端为同一会话生成稳定的 `user_id`，并维护扣子返回的 `conversation_id`，后续请求一并带上，扣子可延续上下文、减少重复处理。
- **自动保存历史**：请求中增加 `auto_save_history: true`，便于扣子端利用历史。
- **兼容与降级**：若流式失败或无内容，自动回退到 `POST /api/chat` 非流式接口（同样支持 user_id / conversation_id），保证可用性。

**接口与解析**：流式接口已按扣子 v2 chat 的 SSE 格式解析，仅将 `message.type === "answer"`（或 `"text"`）的正文推给前端，避免思考过程等无关内容；`conversation_id` 在首包中即下发，便于多轮复用。

### 扣子侧可优化项（在扣子后台/智能体配置中调整）

首字延迟（TTFT）主要由模型与部署决定，以下可在**扣子后台**间接改善体感：

| 项 | 说明 |
|----|------|
| **压缩输出** | 提示词中约束“简洁回答”“分点简短”，减少输出 token，总时长下降。 |
| **精简插件/工具** | 方法名尽量短、参数少；非必要插件可关，避免插件调用阻塞首包。 |
| **知识库与上下文** | 知识库过大或上下文过长会拉高推理时间，可适当裁剪或分拆。 |
| **工作流** | 避免循环依赖、过长的多步编排，否则首 token 会等流程推进。 |
| **限流** | 高频并发可能触发 QPM/QPS 限制，表现为间歇性变慢或失败。 |

如需进一步优化，可在扣子后台检查上述配置（知识库大小、插件数量、提示词长度），适当精简以降低首 token 延迟。

---

## 三、面向中国用户的替代方案

若希望**换用其他模型/平台**以进一步提速或降低成本，以下均为国内可用的选项（需自行申请 API Key 并做合规与备案）：

| 方案 | 说明 | 特点 |
|------|------|------|
| **通义千问（阿里云 DashScope）** | 阿里云灵积模型服务 | 国内可直接用，支持流式，中文表现好，有官方 Node SDK。 |
| **文心一言（百度 ERNIE）** | 百度千帆大模型平台 | 国内可用，支持流式，适合中文场景。 |
| **智谱 ChatGLM / GLM-4** | 智谱 AI 开放平台 | 国内可用，API 简单，支持流式。 |
| **月之暗面 Kimi（Moonshot）** | Moonshot API | 国内可用，长文本与对话能力较强。 |
| **DeepSeek（深度求索）** | DeepSeek API | 国内可用，性价比高，支持流式。 |
| **扣子（Coze）** | 当前使用 | 智能体编排、插件、知识库能力强；已通过流式优化体感。 |

对接方式建议：

- 各厂商均提供 **REST API + 流式**，可在服务端封装类似 `/api/chat` 与 `/api/chat/stream` 的接口，前端无需大改。
- 若希望保留“智能体”能力（多步、插件、知识库），可继续以扣子为主；若更看重**纯对话速度与成本**，可增加一路“直连大模型”（如通义、智谱、DeepSeek），在配置或前端选择“快速咨询”时走直连，与扣子并存。

---

## 四、环境变量（当前扣子）

- `COZE_API_KEY`：扣子开放平台 Personal Access Token  
- `COZE_BOT_ID`：智能体 Bot ID（默认已写于代码）

流式与非流式共用上述配置。
