# 网站与企业微信互发消息说明

## 当前能力

| 方向 | 实现方式 | 状态 |
|------|----------|------|
| **网站 → 企业微信群** | 群机器人 Webhook | ✅ 已实现（新用户/顾问注册、跟进人离线通知等） |
| **企业微信 → 网站** | 自建应用接收消息回调 | ✅ 已实现：应用内发文本会写入对应案件会话，会员消息页可见 |

## 一、网站 → 企业微信群（已用）

- 在**企业微信群**里添加「**群机器人**」（不是 Smart 大模型机器人），复制 Webhook 地址。
- 在 `.env` / Vercel 中配置：`WECHAT_WEBHOOK_URL="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx"`  
- 系统会在以下场景往该群发消息：
  - 新会员 / 新顾问注册
  - 会员发消息或文件、未接来电且跟进人不在线时

## 二、企业微信 → 网站（需配置自建应用）

群机器人**只能发、不能收**。要让「企业微信里发的消息同步到网站」，需用**自建应用 + 接收消息**。

### 1. 创建自建应用

1. 登录 [企业微信管理后台](https://work.weixin.qq.com/)。
2. **应用管理** → **自建** → **创建应用**，记下 **AgentId**、**Secret**。
3. **我的企业** → **企业信息**，记下 **企业ID (CorpID)**。

### 2. 配置接收消息

1. 进入该应用 → **接收消息** → **设置 API 接收**。
2. 填写：
   - **URL**：`https://www.jiayi.co/api/wechat/receive`（生产）或本地用内网穿透后的地址。
   - **Token**：自定义英文/数字，≤32 位（如 `jiayi2026`）。
   - **EncodingAESKey**：点击随机获取，保存 43 位密钥。

### 3. 环境变量

在 `.env` / Vercel 中增加：

```env
WECHAT_CORP_ID="企业ID"
WECHAT_CALLBACK_TOKEN="上一步填的 Token"
WECHAT_ENCODING_AES_KEY="上一步的 43 位 EncodingAESKey"
```

保存后**重新部署**，再在企业微信里点击「保存」完成 URL 校验。

### 4. 顾问身份绑定（群回复同步到网站）

回复会写入「最近收到过离线通知」的案件会话。需让系统知道「企业微信里的谁 = 网站里的哪位顾问」：

- **方式 A（推荐）**：在数据库 RCIC 表为该顾问填写 **wechatUserId**（企业微信成员账号，管理后台/通讯录可见）。
- **方式 B**：在 Vercel / `.env` 配置 `WECHAT_USERID_RCIC_ID`，多组用英文逗号分隔：`userid1:rcicId1,userid2:rcicId2`（如 `ZhangSan:clxxx,LiSi:clyyy`），方便多顾问无需改库即可绑定。

会员发消息且跟进人不在线时，系统会往群发通知，并记录该案件的顾问为「最近被通知人」；该顾问在企业微信应用内回复的**文本消息**会写入该案件会话，会员在网站消息页即可看到。

### 5. 互发效果

- **网站 → 群**：继续用现有 Webhook，通知会发到群。
- **企业微信 → 网站**：成员在**该自建应用**里发**文本消息**（工作台点进应用发），回调会解析并写入对应案件会话，会员中心消息页可见。  
  （注意：是「发到自建应用」的消息会回调；若自建应用被加到群且支持群内 @ 应用发消息，则群内回复也会回调，视企业微信配置而定。）

## 参考文档

- [消息推送（原「群机器人」）](https://developer.work.weixin.qq.com/document/path/99110)（发到群）
- [接收消息与事件](https://developer.work.weixin.qq.com/document/path/90238)、[加解密方案](https://developer.work.weixin.qq.com/document/path/90968)（收消息）
