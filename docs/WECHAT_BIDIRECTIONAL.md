# 网站与企业微信互发消息说明

## 消息往来全流程（顾问外出时用企业微信回复）

```
会员在网站发消息
       ↓
  [保存到案件会话]
       ↓
 跟进人不在线？ ──否──→ 仅站内（顾问在线时在后台看）
       │
      是
       ↓
 ① 群机器人 Webhook 发通知到企业微信群
 ② 记录「该顾问最近被通知的案件」lastWechatNotifiedCaseId
       ↓
 顾问在企业微信里看到通知
       ↓
 ③ 顾问在「自建应用」里发文字（工作台打开应用 / 或群里 @ 该应用）
       ↓
 企业微信把消息 POST 到我们的回调 URL（加密）
       ↓
 ④ 我们解密 → 用 FromUserName 匹配顾问 wechatUserId → 用 lastWechatNotifiedCaseId 找到案件 → 写入会话
       ↓
 会员在网站消息页看到顾问回复
```

**要点**：顾问的回复必须发在**自建应用**里（工作台点进应用发，或群聊里 @ 该应用发），不能只在群里普通发言；且管理后台要为该顾问填好「企业微信账号」（即通讯录里的成员 UserID，与回调里 FromUserName 一致）。

## 当前能力

| 方向 | 实现方式 | 状态 |
|------|----------|------|
| **网站 → 企业微信群** | 群机器人 Webhook | ✅ 已实现（新用户/顾问注册、跟进人离线通知等） |
| **企业微信 → 网站** | 自建应用接收消息回调 | ✅ 已实现：应用内发文本会写入对应案件会话，会员消息页可见 |

## 一、网站 → 企业微信群（已用）

- 在**企业微信群**里添加「**群机器人**」（不是 Smart 大模型机器人），复制 Webhook 地址。
- 在 `.env` / Vercel 中配置：`WECHAT_WEBHOOK_URL="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx"`  
- 系统会在以下场景往该群发消息：
  - 新会员 / 新顾问注册
  - 会员发消息或文件、未接来电且跟进人不在线时

## 二、企业微信 → 网站（需配置自建应用）

群机器人**只能发、不能收**。要让「企业微信里发的消息同步到网站」，需用**自建应用 + 接收消息**。

### 1. 创建自建应用

1. 登录 [企业微信管理后台](https://work.weixin.qq.com/)。
2. **应用管理** → **自建** → **创建应用**，记下 **AgentId**、**Secret**。
3. **我的企业** → **企业信息**，记下 **企业ID (CorpID)**。

### 2. 配置接收消息

1. 进入该应用 → **接收消息** → **设置 API 接收**。
2. 填写：
   - **URL**：`https://www.jiayi.co/api/wechat/receive`（生产）或本地用内网穿透后的地址。
   - **Token**：自定义英文/数字，≤32 位（如 `jiayi2026`）。
   - **EncodingAESKey**：点击随机获取，保存 43 位密钥。

### 3. 环境变量

在 `.env` / Vercel 中增加：

```env
WECHAT_CORP_ID="企业ID"
WECHAT_CALLBACK_TOKEN="上一步填的 Token"
WECHAT_ENCODING_AES_KEY="上一步的 43 位 EncodingAESKey"
```

保存后**重新部署**，再在企业微信里点击「保存」完成 URL 校验。

**若 Vercel 日志出现 `bad decrypt`：** 说明解密用的密钥与企业微信当前使用的不一致。请按下面做一次「重置密钥」（顺序不要反）：

1. 企业微信管理后台 → 该自建应用 → **接收消息**。
2. 点击 **「随机获取」** 重新生成 **EncodingAESKey**（43 位），**先不要点保存**。
3. **立刻**把输入框里显示的 **43 位**密钥**完整复制**（只复制密钥本身，不要带引号、空格、换行）。
4. 到 Vercel → 该项目 → **Settings** → **Environment Variables** → 编辑 **WECHAT_ENCODING_AES_KEY**，**粘贴为刚复制的 43 位**（Vercel 里不要手动加引号），保存。
5. Vercel **Deployments** → 对最新一次部署点 **Redeploy**，等部署完成。
6. 回到企业微信「接收消息」页面，再点**保存**（此时 URL 会重新校验，通过即可）。

说明：代码已对密钥做规范化（自动去掉首尾引号/空格），若仍 bad decrypt，一定是「Vercel 里的密钥」与「企业微信后台当前保存的 EncodingAESKey」不是同一串，按上面步骤用「新随机密钥」两边一致即可。

### 4. 顾问身份绑定（群回复同步到网站）

回复会写入「最近收到过离线通知」的案件会话。需让系统知道「企业微信里的谁 = 网站里的哪位顾问」：

- 在**管理后台 → RCIC 顾问审核**中，点击某顾问「查看详情」，在「企业微信账号」处填写该顾问在企业微信的成员账号（通讯录可见），保存即可。顾问有变动时在此增删或修改即可，无需改环境变量。

会员发消息且跟进人不在线时，系统会往群发通知，并记录该案件的顾问为「最近被通知人」；该顾问在企业微信应用内回复的**文本消息**会写入该案件会话，会员在网站消息页即可看到。

### 5. 自建应用怎样加到企业微信群

顾问要在**群里**回复并同步到网站，需要让「发到自建应用的消息」能触发回调，有两种方式：

**方式一：把自建应用加到群聊（推荐，顾问可在群里 @ 应用发消息）**

1. 用**手机企业微信**或 **PC 企业微信**打开**目标群聊**（和发「跟进人不在线」通知的群可以是同一个）。
2. 点击群聊右上角 **「···」**（群设置）。
3. 在群设置里找 **「添加群机器人」** 或 **「添加应用」** 等入口（不同版本/终端可能名称不同）：
   - 若看到 **「添加群机器人」** 且只有「新建机器人」：那是 Webhook 机器人（只能发不能收），**不要**用这个来收回复。
   - 若看到 **「添加应用」** 或 **「从企业应用添加」**：选择你们已配置好「接收消息」的**自建应用**，加入群。
4. 加入后，顾问在群里输入 **@**，选择该**自建应用**，再输入文字发送，即可触发回调，同步到网站会员消息栏。

若当前版本群设置里**没有「添加应用」**入口，可改用方式二。

**方式二：顾问在工作台打开自建应用发消息（不依赖加群）**

1. 顾问在企业微信 **工作台** 里找到你们的**自建应用**，点进去。
2. 在应用会话窗口里直接发**文字消息**，同样会触发接收消息回调，同步到网站会员消息栏。

两种方式只要有一种可用即可；管理后台已为该顾问填好「企业微信账号」、且会员发过消息触发过「跟进人不在线」通知后，顾问用上述任一方式发文字都会落到对应案件会话。

### 6. 互发效果

- **网站 → 群**：继续用现有 Webhook，通知会发到群。
- **企业微信 → 网站**：顾问在**自建应用**里发**文本消息**（群内 @ 该应用，或工作台打开该应用发），回调会解析并写入对应案件会话，会员中心消息页可见。

## 排错：企业微信回复收不到 / 不同步到网站

按下面顺序自查：

1. **URL 校验是否通过**  
   在管理后台保存「接收消息」时，必须一次成功。若失败：检查 Vercel 的 `WECHAT_CALLBACK_TOKEN`、`WECHAT_ENCODING_AES_KEY` 与后台填的 **完全一致**（Token 区分大小写；EncodingAESKey 43 位、无空格/换行），且部署已完成后再点保存。

2. **回复是否发在「自建应用」里**  
   顾问要在**工作台打开该自建应用发文字**，或**在群里 @ 该应用再发**。在群里普通 @ 同事发、或发到别的应用，都不会触发我们的回调。

3. **顾问身份是否绑定**  
   管理后台 → RCIC 顾问审核 → 该顾问详情 →「企业微信账号」必须填写为该顾问在**通讯录里的成员 UserID**（与回调里的 FromUserName 一致）。若不确定，可在 Vercel 日志里看 `[WeChat receive] from: "xxx"`，把这里的 `xxx` 填到「企业微信账号」。

4. **是否有可关联的案件**  
   系统用「该顾问最近被通知的案件」来落库。若顾问从未收到过「跟进人不在线」的群通知，就没有 lastWechatNotifiedCaseId，回复会无法关联案件。请先让会员发一条消息（顾问保持离线），等群通知发出后，再用企业微信在自建应用里回复。

5. **解密失败（如 bad decrypt）**  
   说明 EncodingAESKey 与当前后台使用的不一致。做法：后台该应用 → 接收消息 → 点「随机获取」得到新 EncodingAESKey → 保存 → 立刻把**新 43 位**复制到 Vercel 的 `WECHAT_ENCODING_AES_KEY` → 重新部署 → 再回后台点保存完成校验。

6. **receiveId mismatch**  
   若日志出现该错误，说明解密后的企业 ID 与配置的 `WECHAT_CORP_ID` 不一致。请确认 Vercel 的 `WECHAT_CORP_ID` 为「我的企业 → 企业信息」里的企业 ID。

## 参考文档

- [消息推送（原「群机器人」）](https://developer.work.weixin.qq.com/document/path/99110)（发到群）
- [接收消息与事件](https://developer.work.weixin.qq.com/document/path/90238)、[加解密方案](https://developer.work.weixin.qq.com/document/path/90968)（收消息）
