---
description: 加移项目开发与部署规则，开发时务必遵守
globs: 
alwaysApply: true
---

# 加移 (jiayi.co) 开发规则

开发、改代码、部署时请先查看本规则并遵守。

## 一、输出与文件

- **涉及的文件**：一律使用**完整绝对路径**（例如 `C:\Users\User\jiayi-ai-assistant\src\app\api\rcic\auth\login\route.ts`）。
- **不写报告**：不需要单独写报告或说明文档，除非用户明确要求。
- **不单独说明错误出处**：直接给出修改结果或正确写法即可。

## 二、部署前核对

- **部署前必须核对**：本地 schema/迁移 与 **服务器（生产）数据库** 一致。
- 避免生产库与本地不一致导致：管理员能看到数据但登录失败、或其它异常。
- 若需确认生产库数据，可让用户调用管理员接口（如 `/api/admin/rcic/status`、`/api/admin/rcic/count`）或本地用相同 `DATABASE_URL` 跑脚本核对。

## 三、Prisma 与数据库

- **Prisma 版本**：项目内保持 Prisma 版本一致（与 package.json 一致）。
- **数据库**：本项目使用 **TiDB Cloud（MySQL 协议）**，连接串环境变量为 **`DATABASE_URL`**。不要使用或依赖 `POSTGRES_*` 等旧变量。
- **Schema 与 MySQL**：TiDB/MySQL 不支持 Prisma 的 `mode: "insensitive"`，查询时不要使用；长文本（如 data URL、base64、简介）使用 `@db.LongText` 或 `@db.Text`，避免 VARCHAR(191) 超长报错。
- **每次增改功能后**：执行 `prisma generate`，需要时执行 `prisma db push` 或 `prisma migrate`，保证**本地 schema 与数据库一致**。

## 四、Vercel 部署

- 每次 push 到 GitHub 后 Vercel 会**自动部署**；只需跟踪部署是否成功。
- **部署成功后不需要生成报告**。
- 环境变量：生产环境只依赖 **`DATABASE_URL`**（TiDB Cloud MySQL 连接串），不要依赖已废弃的 `POSTGRES_*`。

## 五、修改代码时的原则

- **首先确保不破坏已有正常功能**；改完后如有必要做本地构建（`npm run build`）验证。
- **不能随便改变业务/产品流程**；若要改流程，必须先问用户确认后再改。

## 六、移民顾问（RCIC）流程（不可改）

- **顺序固定**：注册 → **先验证邮箱** → 再管理员审核 → **审核通过后才能登录**。
- 登录接口必须校验：`emailVerified === true`、`approvalStatus === 'approved'`、`isActive === true`，否则拒绝登录并给出明确提示。
- 顾问与文案/操作员**同一登录入口**（如 `/rcic/login`），通过账号区分：先查持牌顾问（RCIC），再查团队成员（文案/操作员）；同一邮箱时**持牌顾问优先**。

## 七、工作流习惯

- 修改或新增功能后：先 `prisma generate`，必要时 `prisma db push` 或 `prisma migrate`，再构建与部署。
- 部署前再次确认：本地与服务器使用的数据库（TiDB）一致，避免“本地有数据、线上没有”或反之导致的登录/数据问题。
