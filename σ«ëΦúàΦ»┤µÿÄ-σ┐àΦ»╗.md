# 🚀 嘉怡移民助手 - 完整项目安装说明

## ⚡ 超快速安装（5分钟）

### 第一步：复制项目（1分钟）

**将整个 `jiayi-complete` 文件夹的内容复制到您的项目目录，选择"全部覆盖"**

```
C:\Users\User\jiayi-ai-assistant\
```

---

### 第二步：配置数据库（2分钟）

#### 选项 A：使用 Vercel Postgres（推荐）

1. 访问 https://vercel.com/dashboard
2. 进入您的项目
3. 点击 "Storage" → "Create Database" → "Postgres"
4. 复制 `DATABASE_URL`
5. 粘贴到 `.env.local` 文件

#### 选项 B：使用 Supabase（免费）

1. 访问 https://supabase.com
2. 创建新项目
3. 进入 "Project Settings" → "Database"
4. 复制 "Connection string" (选择 "URI")
5. 粘贴到 `.env.local` 文件

#### 选项 C：本地 PostgreSQL

```env
DATABASE_URL="postgresql://postgres:password@localhost:5432/jiayi_db"
```

**编辑 `.env.local` 文件，替换 DATABASE_URL：**

```env
DATABASE_URL="postgresql://你的数据库连接"
```

---

### 第三步：安装依赖和初始化数据库（2分钟）

```bash
# 安装依赖
npm install

# 生成 Prisma Client
npx prisma generate

# 推送数据库 Schema
npx prisma db push
```

---

### 第四步：启动项目

```bash
npm run dev
```

访问：http://localhost:3000/auth/register

---

## ✅ 已包含的功能

### 用户功能
- ✅ 用户注册（邮箱验证）
- ✅ 邮箱验证（24小时有效）
- ✅ 密码登录
- ✅ 重发验证邮件
- ✅ 欢迎邮件

### 顾问功能
- ✅ 顾问注册（A/B/C三个等级）
- ✅ 邮箱验证
- ✅ 资质审核流程
- ✅ 密码登录（审核通过后）
- ✅ 文档上传

### 管理功能
- ✅ 顾问审核（批准/拒绝/暂停）
- ✅ 定期复核（A类顾问6个月）

---

## 📁 项目结构

```
jiayi-complete/
├── src/
│   ├── app/
│   │   ├── api/              # API 路由
│   │   │   ├── auth/         # 认证相关
│   │   │   │   ├── register/
│   │   │   │   ├── rcic/register/
│   │   │   │   ├── login/
│   │   │   │   ├── verify-email/
│   │   │   │   └── send-verification/
│   │   │   └── admin/        # 管理员功能
│   │   └── auth/             # 认证页面
│   │       ├── register/
│   │       ├── rcic/register/
│   │       ├── login/
│   │       ├── verify/
│   │       └── resend-verification/
│   └── lib/
│       ├── email.ts          # 邮件服务
│       └── prisma.ts         # 数据库客户端
├── prisma/
│   └── schema.prisma         # 数据库模型（已修复）
├── .env.local                # 环境变量（需要配置）
├── .env                      # 环境变量模板
├── package.json              # 依赖配置
└── 安装说明-必读.md          # 本文件
```

---

## 🎯 测试流程

### 1. 用户注册测试

1. 访问：http://localhost:3000/auth/register
2. 填写注册信息
3. 检查邮箱收到验证邮件
4. 点击验证链接
5. 登录测试

### 2. 顾问注册测试

1. 访问：http://localhost:3000/auth/rcic/register
2. 选择顾问类型（A/B/C）
3. 填写资质信息
4. 邮箱验证
5. 等待审核
6. 审核通过后登录

---

## 🔧 环境变量说明

### 必须配置的变量

```env
# 数据库连接（必须）
DATABASE_URL="postgresql://..."

# JWT 密钥（必须，生产环境必须更换）
JWT_SECRET="your-super-secret-jwt-key-change-in-production-min-32-chars"
```

### 已配置的变量

```env
# Resend 邮件服务（已配置好）
RESEND_API_KEY=re_EofwxaXN_JmPh8P7zLx3nK5RbmgwsvXiF
EMAIL_FROM=noreply@jiayi.co
EMAIL_FROM_NAME=嘉怡移民助手

# 应用URL（本地开发）
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

## ⚠️ 重要提示

### 1. 删除了 pages 文件夹

已经删除了会导致冲突的 `pages` 文件夹，现在只使用 `src/app` 目录（App Router）。

### 2. 数据库必须配置

项目无法启动直到配置了有效的 `DATABASE_URL`。

### 3. JWT_SECRET 必须更换

生产环境部署时，必须更换 `JWT_SECRET` 为强密钥。

---

## 📊 数据库模型

### User（用户）
- 基本信息、邮箱验证、密码加密
- 关联：cases, messages

### RCIC（移民顾问）
- 基本信息、邮箱验证、密码加密
- 顾问类型：A（持牌）、B（留学）、C（文案）
- 审核状态：pending, under_review, approved, rejected, suspended
- 资质文档：身份证件、执照、从业证明、视频认证
- 关联：cases, messages

### VerificationToken（验证令牌）
- 邮箱验证、密码重置
- 24小时有效期

### Case（案件）
- 用户和顾问的案件管理

### Message（消息）
- 案件相关的消息记录

---

## 🐛 常见问题

### 问题 1：npm install 失败

**解决方案：**
```bash
# 清除缓存
npm cache clean --force
# 重新安装
npm install
```

### 问题 2：Prisma 错误

**解决方案：**
```bash
# 批准 Prisma 构建脚本
pnpm approve-builds
# 重新生成
npx prisma generate
```

### 问题 3：数据库连接失败

**检查清单：**
- [ ] DATABASE_URL 格式正确
- [ ] 数据库服务正在运行
- [ ] 网络连接正常
- [ ] 用户名密码正确

### 问题 4：邮件发送失败

**检查清单：**
- [ ] RESEND_API_KEY 正确
- [ ] EMAIL_FROM 配置正确
- [ ] DNS 记录已验证（jiayi.co）

---

## 🚢 部署到生产环境

### Vercel 部署

1. **推送代码到 GitHub**
   ```bash
   git add .
   git commit -m "Complete authentication system"
   git push
   ```

2. **在 Vercel 配置环境变量**
   - `DATABASE_URL`
   - `JWT_SECRET`
   - `RESEND_API_KEY`
   - `EMAIL_FROM`
   - `EMAIL_FROM_NAME`
   - `NEXT_PUBLIC_APP_URL`

3. **等待自动部署**

4. **运行数据库迁移**
   ```bash
   npx prisma db push
   ```

---

## 📞 需要帮助？

### 查看日志
- 开发服务器：`npm run dev` 的输出
- 浏览器控制台：F12
- 数据库：`npx prisma studio`
- 邮件日志：https://resend.com/logs

### 测试数据库连接
```bash
npx prisma db pull
```

### 查看数据库内容
```bash
npx prisma studio
```

---

## 🎉 完成！

现在您可以开始测试了！

**测试地址：**
- 用户注册：http://localhost:3000/auth/register
- 顾问注册：http://localhost:3000/auth/rcic/register
- 登录页面：http://localhost:3000/auth/login

**祝您测试顺利！** 🚀
